---
title: "Proyecto Introduccion a la Mineria de Datos"
output: html_notebook
---

### Librerias

Para la manipulacion y aplicar los diferentes algortimos de mineria de datos se usaron las siguientes librerias.

```{r}
library(ggplot2)
library(arules)
library(arules)
library(dplyr)
```

# Lectura de Datasets

Los datasets se encuentran en la carpeta datasets, estos se enceuntran en diferetnes formatos:

1.  CSV, con datos normalizados
2.  CSV, con datos con diccionario integrado
3.  Excel, con datos normalizados
4.  Excel, con datos con diccionario integrado
5.  Archivo SAV, de la herramienta de IBM SPSS. Con el cual se exportaron cada una de las otras fuentes de datos.

-   Los años 2022 y 2023, unicamente cuentan con fuente de datos con diccionario integrado.

-   El año 2022, le hace falta el la columna hora_ocu, que identifica la hora del delito.

## Lectura de CSV

Se usaran los datos de los archivos CSV, con el diccionario integrado.Para poder integrar los datasets de los años 2022 y 2023.

```{r}
victimas_2016 <- read.csv("datasets/vd16.csv")
victimas_2017 <- read.csv("datasets/vd17.csv")
victimas_2018 <- read.csv("datasets/vd18.csv")
victimas_2019 <- read.csv("datasets/vd19.csv")
victimas_2020 <- read.csv("datasets/vd20.csv")
victimas_2021 <- read.csv("datasets/vd21.csv")
victimas_2022 <- read.csv("datasets/vd22.csv")
victimas_2023 <- read.csv("datasets/vd23.csv")

```

## Dataset consolidado

Se creara un dataset uniendo todos los datasets

```{r}

victimas <- rbind(victimas_2016, victimas_2017, victimas_2018, victimas_2019, victimas_2020, victimas_2021, victimas_2022, victimas_2023)

victimas

```

El dataset final, Tiene el tamaño de 248076 x 18 variables.

# Reglas de Asociacion

Para las reglas de asociacion tenemos dos opcions Apriori o FP-Growth. Las asociaciones seran aplicadas con FP-Growth, Y se basaran todas filtrando en base al grupo del delitoy el genero de al victima:

## Primera asociacion

Podemos partir en la separacion de delitos para un estudio mas filtrado entre los diferentes tipos de delitos que sufren los guatemaltecos.

### Victimas de homicidios

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Homicidios") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.25, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

De estos resultados podemos deducir varias cosas. Como que el homicidio por arma de fuego es el delito cometido a las victimas de homicidido en conjunto con que este delito se incremento del 2020 al 2023 en el departamento de Guatemala.

Pero vemos que la tendencia por la cantidad de homicidios que sufren los hombres en Guatemala es mayor que las Mujeres. Por lo que vamos a separar el sexo de las personas para ver las tendencias de Homicidios en Hombre y Mujeres respectivamente.

#### Hombres victimas de homicidios

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Homicidios" & sexo_per == "Hombre") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu, -sexo_per)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.25, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

Nos da informacion similar a ver el analisis sin filtrar el sexo de la victima. Y podemos asociar lo siguiente:

-   Que los homicidios de los hombres por arma de fuego se dieron principalmente del 2020 al 2023.

-   Que los homicidios de los hombres por arma de fuego se dieron por la noche.

-   Que los homicidios de los hombres por arma de fuego se dieron en el departamento de Guatemala.

#### Muejeres victimas de homicidios

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Homicidios" & sexo_per == "Mujer") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu, -sexo_per)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.25, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

Nos da informacion similar al analisis de los hombres victimas de homicidio. Y podemos asociar lo siguiente:

-   Que los homicidios de las mujeres por arma de fuego se dieron principalmente del 2020 al 2023.

-   Que los homicidios de las mujeres por arma de fuego se dieron por la noche.

-   Que los homicidios de las mujeres por arma de fuego se dieron en el departamento de Guatemala.

## Segunda Asociacion

Seguiremos con el analisis separandolo por el grupo de delitos, ahora para otro tipo de de delito.

### Victimas de Lesiones

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Lesiones") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.25, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

Por estes analisis podemos determinar que el mayor delito por Lesion, Lesion por arma de fuego. Y que son los hombres en el departamento de Guatemala los que son mas victimas de este delito.

Para ver si las mujeres mantinen esta tendencia haremos el filtrado para cada sexo.

#### Hombres victimas de lesiones

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Lesiones" & sexo_per == "Hombre") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu, -sexo_per)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.25, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

Nos da informacion similar a ver el analisis sin filtrar el sexo de la victima. Y podemos asociar lo siguiente:

-   Que las lesiones de los hombres por arma de fuego se dieron por la noche.

-   Que las lesiones de los hombres por arma de fuego se dieron en el departamento de Guatemala.

#### Mujeres victimas de lesiones

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Lesiones" & sexo_per == "Mujer") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu, -sexo_per)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.25, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

Nos da informacion similar a ver el analisis de los hombre. Y podemos asociar lo siguiente:

-   Que las lesiones de las mujeres por arma de fuego se dieron por la noche.

-   Que las lesiones de los mujeres por arma de fuego se dieron en el departamento de Guatemala.

## Tercera Asociacion

### Victimas contra el patrimonio

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Contra el patrimonio") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.2, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

Por estes analisis podemos observar que no mayor asociacion evidente, Se procedera a el filtrado por sexo para determinar si entre hombre y mujeres hay una asociacion mas directa.

#### Victimas hombres en contra el patrimonio

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Contra el patrimonio" & sexo_per == "Hombre") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu, -sexo_per)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.2, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

No nos da un delito particular pero si podemos asociar lo siguiente:

-   Que los delitos en contra el patrimonio en los hombres se dieron por la mañana en el departamento de Guatemala.

#### Victimas mujeres en contra el patrimonio

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Contra el patrimonio" & sexo_per == "Mujer") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu, -sexo_per)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.2, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

No nos da un delito particular pero si podemos asociar lo siguiente:

-   Que los delitos en contra el patrimonio en las mujeres se dieron del 2020 al 2023.

## Cuarta Asociacion

### Victimas contra la libertad

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Contra la libertad") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu, -g_edad_60ymás, -g_edad_80ymás)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.2, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

Por estes analisis podemos determinar que el mayor delito encontra de la libertad, es la desaparicion. Y que son las mujeresen las que son mas victimas de este delito.

Para ver si los hombres mantinen esta tendencia haremos el filtrado para cada sexo.

#### Victimas hombres contra su libertad

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Contra la libertad" & sexo_per == "Hombre") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu, -sexo_per, -g_edad_60ymás, -g_edad_80ymás)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.2, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

Podemos asociar lo siguiente:

-   Que se vulnero la libertad de los hombres por el delito desaparecidos entre los años 2016-2021

-   Que se vulnero la libertad de los hombres por el delito desaparecidos por la mañana

-   Que se vulnero la libertad de los hombres por el delito desaparecidos en el departamento de Guatemala.

#### Victimas mujeres contra su linertad

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Contra la libertad" & sexo_per == "Mujer") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu, -sexo_per, -g_edad_60ymás, -g_edad_80ymás)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.2, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

Podemos asociar:

-   Que se vulnero la libertad de las mujeres por el delito desaparecidos entre los años 2016-2021

-   Que se vulnero la libertad de las mujeres por el delito desaparecidos con edad entre 15 y 19 años

-   Que se vulnero la libertad de las mujeres por el delito desaparecidos por la mañana

## Quinta Asociacion

### Victimas de extorsion

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Extorsión") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu, -g_edad_60ymás, -g_edad_80ymás)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.2, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

Por estes analisis podemos determinar que el mayor delito de extrosion, es la extorsion a residencias. Y que son los hombres mnas victimas de este delito

Para ver si las mujeres mantinen esta tendencia haremos el filtrado para cada sexo.

#### Victimas hombres de extorsion

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Extorsión" & sexo_per == "Hombre") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu, -sexo_per, -g_edad_60ymás, -g_edad_80ymás)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.2, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

Podemos asociar lo siguiente:

-   Que los hombres son victimas de extorsion por el delito de extorsion a residencias

-   Que los hombres son victimas de extorsion por el delito de extorsion a residencias por la tarde

-   Que los hombres son victimas de extorsion por el delito de extorsion a residencias en los años 2021-2022

-   Que los hombres son victimas de extorsion por el delito de extorsion a comercion principalmente en el departamento de Guatemala

#### Victimas mujeres de extorsion

```{r}
victimas_aso <- victimas %>%
  filter(g_delitos == "Extorsión" & sexo_per == "Mujer") %>%
  select(-núm_corre,-g_delitos, -zona_ocu, -g_hora, -día_ocu, -sexo_per, -g_edad_60ymás, -g_edad_80ymás)
  
r <- fim4r(victimas_aso, method="fpgrowth", target="rules", supp=.2, conf=.5)
rframe <- as(r, "data.frame")
rframe
```

Podemos asociar lo siguiente:

-   Que los hombres son victimas de extorsion por el delito de extorsion a residencias

-   Que los hombres son victimas de extorsion por el delito de extorsion a residencias por la tarde

-   Que los hombres son victimas de extorsion por el delito de extorsion a residencias en los años 2021-2022

# Análisis de clúster

```{r}
victimas_2016 <- read.csv("datasets/v16.csv")
victimas_2017 <- read.csv("datasets/v17.csv")
victimas_2018 <- read.csv("datasets/v18.csv")
victimas_2019 <- read.csv("datasets/v19.csv")
victimas_2020 <- read.csv("datasets/v20.csv")
victimas_2021 <- read.csv("datasets/v21.csv")

victimas <- rbind(victimas_2016, victimas_2017, victimas_2018, victimas_2019, victimas_2020, victimas_2021)

victimas
```

### Cluster - Delito vs Edad de victima

```{r}
victimas_cluster <- victimas %>%
  filter(edad_per < 100)
  

result_kmeans  <- kmeans (victimas_cluster, centers = 2)

ggplot(victimas_cluster, aes(x = edad_per , y = g_delitos , color = as.factor(result_kmeans$cluster))) +
  geom_point() + 
  geom_point(data = as.data.frame(result_kmeans$centers), aes(x = edad_per, y = g_delitos), color = "black", size = 4, shape = 17) +
  labs(title = "Edad victima vs Grupo delito") +
  theme_minimal()
```

En este cluster podemos ver dos grupos. Y claramente se ve la tendencia que el grupo de Victimas #1 sufre mas delitos de categoria 4, que la fuente de datos no la tiene etiquetada. Pero son delitos, relacionados con Violaciones y son los unicos reportados y son del 2016.

### Cluster - Homicidios

```{r}
victimas_cluster <- victimas%>%
  filter(edad_per <100)%>%
  filter(g_delitos == 1)%>% #Homicidios
  select(-núm_corre, -zona_ocu, -g_hora, -g_edad_60ymás, -g_edad_80ymás)
  
  

result_kmeans  <- kmeans (victimas_cluster, centers = 3)

ggplot(victimas_cluster, aes(x = edad_per , y = mes_ocu , color = as.factor(result_kmeans$cluster))) +
  geom_point() + 
  geom_point(data = as.data.frame(result_kmeans$centers), aes(x = edad_per, y = mes_ocu), color = "black", size = 4, shape = 17) +
  labs(title = "Homicidios, Edad vs Mes Ocurrencia") +
  theme_minimal()
```

### Cluster - Lesiones, Edad vs Mes Ocurrencia

```{r}
victimas_cluster <- victimas%>%
  filter(edad_per <100)%>%
  filter(g_delitos == 2)%>% #Lesiones
  select(-núm_corre, -zona_ocu, -g_hora, -g_edad_60ymás, -g_edad_80ymás)
  
  

result_kmeans  <- kmeans (victimas_cluster, centers = 3)

ggplot(victimas_cluster, aes(x = edad_per , y = mes_ocu , color = as.factor(result_kmeans$cluster))) +
  geom_point() + 
  geom_point(data = as.data.frame(result_kmeans$centers), aes(x = edad_per, y = mes_ocu), color = "black", size = 4, shape = 17) +
  labs(title = "Lesiones, Edad vs Mes Ocurrencia") +
  theme_minimal()
```

Podemos ver estos dos clusters. Con Grupos variados. Y aun filtrando el tipo de delito que sufrio la victima no hay grupos marcados. Los guatemaltecos y guatemaltecas sufren delitos variados.

# Clasificacion (Arboles de decision)

Para esto necesitamos las siguientes librerias

-   rpart

-   rpart.plot

```{r}
library(rpart)
library(rpart.plot)
```

## Clasificacion de victimas contra su libertad

Se usan las sigueinte variables para generar un arbol de clasificacion para los delitos cometidos contra la libertad:

-   Hora

-   Sexo

-   Edad

-   Departamento

```{r}
victimas_arbol <- victimas %>%
  filter(g_delitos == 5)

arbol <- rpart(delito_com ~ g_hora_mañ.tar.noch+sexo_per+edad_per+depto_ocu, data=victimas_arbol, method = "class")


rpart.plot(arbol,
           type = 2,
           extra = 0,  
           under = TRUE,  
           fallen.leaves = TRUE,  
           box.palette = "BuGn",  
           main = "Victimas contra su libertad",
           cex = 0.45)
```

## Arbol para victimas contra su patriomonio

Se usan las sigueinte variables para generar un arbol de clasificacion para los delitos cometidos contra la libertad:

-   Hora

-   Sexo

-   Edad

-   Departamento

```{r}
victimas_arbol <- victimas %>%
  filter(g_delitos == 3)

arbol <- rpart(delito_com ~ g_hora_mañ.tar.noch+sexo_per+edad_per+depto_ocu, data=victimas_arbol, method = "class")


rpart.plot(arbol,
           type = 2,
           extra = 0,  
           under = TRUE,  
           fallen.leaves = TRUE,  
           box.palette = "BuGn",  
           main = "Victimas contra su libertad",
           cex = 0.45)
```
